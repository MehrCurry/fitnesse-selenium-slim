<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>WebDriverCapabilitiesHelper.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">fitnesse-selenium-slim</a> &gt; <a href="index.source.html" class="el_package">com.github.andreptb.fitnesse.selenium</a> &gt; <span class="el_source">WebDriverCapabilitiesHelper.java</span></div><h1>WebDriverCapabilitiesHelper.java</h1><pre class="source lang-java linenums">
package com.github.andreptb.fitnesse.selenium;

import java.util.HashMap;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.function.BiConsumer;
import java.util.function.BiFunction;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import org.apache.commons.lang3.EnumUtils;
import org.apache.commons.lang3.StringUtils;
import org.apache.commons.lang3.math.NumberUtils;
import org.openqa.selenium.Capabilities;
import org.openqa.selenium.chrome.ChromeOptions;
import org.openqa.selenium.firefox.FirefoxDriver;
import org.openqa.selenium.firefox.FirefoxProfile;
import org.openqa.selenium.ie.InternetExplorerDriver;
import org.openqa.selenium.remote.DesiredCapabilities;

/**
 * Utility class to produce browser driver capabilities. Parses and inject default capabilities commonly used in test environments
 */
<span class="fc" id="L26">public class WebDriverCapabilitiesHelper {</span>

	private static final String FIREFOX_ALLOWED_DOWNLOAD_CONTENT_TYPES = &quot;application/msword, application/csv, application/ris, text/csv, image/png, application/pdf, text/html, text/plain, application/zip, application/x-zip, application/x-zip-compressed, application/download, application/octet-stream&quot;;
	/**
	 * Pattern to parse capability string. Expected format: key='value' or key=&quot;value&quot;
	 */
<span class="fc" id="L32">	private static final Pattern ENCODED_CONFIG_PATTERN = Pattern.compile(&quot;\\s*([^=]+)=['\&quot;]([^'\&quot;]+)['\&quot;]&quot;);</span>

	/**
	 * Enum to inject preferences and capabilities according to the browser. Will inject default preferences or capabilities if applicable
	 */
<span class="pc" id="L37">	private enum CapabilitiesAndPreferencesInjector {</span>
<span class="fc" id="L38">		chrome((capabilities, preferences) -&gt; {</span>
<span class="nc" id="L39">			ChromeOptions chromeOptions = new ChromeOptions();</span>
<span class="nc" id="L40">			CapabilitiesAndPreferencesInjector.applyIfUndefined(&quot;disable-popup-blocking&quot;, Boolean.TRUE.toString(), preferences::getOrDefault, preferences::put);</span>
<span class="nc" id="L41">			chromeOptions.setExperimentalOption(&quot;prefs&quot;, preferences);</span>
<span class="nc" id="L42">			capabilities.setCapability(ChromeOptions.CAPABILITY, chromeOptions);</span>
<span class="nc" id="L43">		}),</span>
<span class="fc" id="L44">		firefox((capabilities, preferences) -&gt; {</span>
<span class="fc" id="L45">			FirefoxProfile firefoxProfile = new FirefoxProfile();</span>
<span class="fc" id="L46">			firefoxProfile.setAcceptUntrustedCertificates(true);</span>
<span class="pc" id="L47">			preferences.forEach((key, value) -&gt; firefoxProfile.setPreference(key, value));</span>
<span class="fc" id="L48">			CapabilitiesAndPreferencesInjector.applyIfUndefined(&quot;browser.download.folderList&quot;, 2, firefoxProfile::getIntegerPreference, firefoxProfile::setPreference);</span>
<span class="fc" id="L49">			CapabilitiesAndPreferencesInjector.applyIfUndefined(&quot;plugin.state.java&quot;, 2, firefoxProfile::getIntegerPreference, firefoxProfile::setPreference);</span>
<span class="fc" id="L50">			CapabilitiesAndPreferencesInjector.applyIfUndefined(&quot;security.enable_java&quot;, true, firefoxProfile::getBooleanPreference, firefoxProfile::setPreference);</span>
<span class="fc" id="L51">			CapabilitiesAndPreferencesInjector.applyIfUndefined(&quot;browser.helperApps.neverAsk.saveToDisk&quot;, WebDriverCapabilitiesHelper.FIREFOX_ALLOWED_DOWNLOAD_CONTENT_TYPES, firefoxProfile::getStringPreference, firefoxProfile::setPreference);</span>
<span class="fc" id="L52">			capabilities.setCapability(FirefoxDriver.PROFILE, firefoxProfile);</span>
<span class="fc" id="L53">		}),</span>
<span class="fc" id="L54">		internetexplorer((capabilities, preferences) -&gt; {</span>
<span class="nc" id="L55">			capabilities.setCapability(InternetExplorerDriver.INTRODUCE_FLAKINESS_BY_IGNORING_SECURITY_DOMAINS, true);</span>
<span class="nc" id="L56">		});</span>

		private BiConsumer&lt;DesiredCapabilities, Map&lt;String, String&gt;&gt; injector;

<span class="fc" id="L60">		private CapabilitiesAndPreferencesInjector(BiConsumer&lt;DesiredCapabilities, Map&lt;String, String&gt;&gt; injector) {</span>
<span class="fc" id="L61">			this.injector = injector;</span>
<span class="fc" id="L62">		}</span>

		private static &lt;K, V&gt; void applyIfUndefined(K key, V defaultValue, BiFunction&lt;K, V, V&gt; configProvider, BiConsumer&lt;K, V&gt; configApplier) {
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">			if (StringUtils.isBlank(Objects.toString(defaultValue, null))) {</span>
<span class="nc" id="L66">				return;</span>
			}
<span class="fc" id="L68">			configApplier.accept(key, configProvider.apply(key, defaultValue));</span>
<span class="fc" id="L69">		}</span>
	}

	/**
	 * Creates {@link Capabilities} from string. Injects default preferences to supported browsers
	 * Supported formats:
	 * &lt;p&gt;
	 * key1='value1' key2='value with space 2' key3='value3'
	 * &lt;/p&gt;
	 * &lt;p&gt;
	 * key1=&quot;value1&quot; key2=&quot;value with space 2&quot; key3=&quot;value3&quot;
	 * &lt;/p&gt;
	 *
	 * @see CapabilitiesAndPreferencesInjector
	 * @param browser Used to determine default configurations to inject
	 * @param capabilities {@link String}
	 * @param preferences Directory to save browser downloaded files
	 * @return capabilitiesInstance which is an instanceof {@link Capabilities}
	 */
	public DesiredCapabilities parse(String browser, String capabilities, String preferences) {
<span class="fc" id="L89">		DesiredCapabilities desiredCapabilities = new DesiredCapabilities();</span>
<span class="fc" id="L90">		parseFromString(capabilities, desiredCapabilities::setCapability);</span>
<span class="fc" id="L91">		Map&lt;String, String&gt; parsedPreferences = new HashMap&lt;&gt;();</span>
<span class="fc" id="L92">		parseFromString(capabilities, desiredCapabilities::setCapability);</span>
<span class="fc" id="L93">		parseFromString(preferences, parsedPreferences::put);</span>
<span class="fc" id="L94">		CapabilitiesAndPreferencesInjector entry = Optional.ofNullable(EnumUtils.getEnum(CapabilitiesAndPreferencesInjector.class, browser))</span>
<span class="fc" id="L95">			.orElse(EnumUtils.getEnum(CapabilitiesAndPreferencesInjector.class, StringUtils.deleteWhitespace(desiredCapabilities.getBrowserName())));</span>
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">		if (entry != null) {</span>
<span class="fc" id="L97">			entry.injector.accept(desiredCapabilities, parsedPreferences);</span>
		}
<span class="fc" id="L99">		return desiredCapabilities;</span>
	}

	private &lt;K, V&gt; void parseFromString(String encodedConfig, BiConsumer&lt;String, String&gt; applier) {
<span class="fc bfc" id="L103" title="All 2 branches covered.">		if (StringUtils.isBlank(encodedConfig)) {</span>
<span class="fc" id="L104">			return;</span>
		}
<span class="fc" id="L106">		Matcher matcher = WebDriverCapabilitiesHelper.ENCODED_CONFIG_PATTERN.matcher(encodedConfig);</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">		while (matcher.find()) {</span>
<span class="fc" id="L108">			String value = matcher.group(2);</span>
<span class="pc bpc" id="L109" title="1 of 2 branches missed.">			if (StringUtils.isNotBlank(value)) {</span>
<span class="fc" id="L110">				applier.accept(matcher.group(NumberUtils.INTEGER_ONE), value);</span>
			}
<span class="fc" id="L112">		}</span>
<span class="fc" id="L113">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>